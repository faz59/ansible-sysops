- name: "Deploy website"
  hosts: all

  vars:
    website_name: MyLinuxApp
    website_version: 0.1
    website_dir: "/var/www/html"
    website_user_owner: "httpd"
    website_user_group: "httpd"
    website_database_pool: "linuxdb"
    website_dbuser: "website"
    website_dbpass: "Password123!"


  tasks:
    - set_fact:
        website_database_servers: "{{ groups[website_database_pool] | list }}"

    - name: "Ensure the state of {{ website_dir }} as folder with proper ownership"
      file:
        path: "{{ website_dir }}"
        owner: "{{ website_user_owner }}"
        group: "{{ website_user_group }}"
        state: directory

    - name: "Build index.php and save to {{ website_dir }}/index.php"
      template:
        src: "templates/index.php.j2"
        dest: "{{ website_dir }}/index.php"
        owner: "{{ website_user_owner }}"
        group: "{{ website_user_group }}"

    - name: "Copy application files to {{ website_dir }}"
      copy:
        src: files/
        dest: "{{ website_dir }}"
        owner: "{{ website_user_owner }}"
        group: "{{ website_user_group }}"
